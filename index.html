<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>eMaktab Galaxy Edition üöÄ</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --accent: #6366f1;
            --accent-hover: #4f46e5;
            --pink: #ec4899;
            --bg-body: #f8fafc;
            --glass: rgba(255, 255, 255, 0.7);
            --border: rgba(255, 255, 255, 0.8);
            --text: #1e293b;
            --shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.05), 0 10px 10px -5px rgba(0, 0, 0, 0.02);
        }

        [data-theme="dark"] {
            --bg-body: #020617;
            --glass: rgba(15, 23, 42, 0.6);
            --border: rgba(255, 255, 255, 0.05);
            --text: #f1f5f9;
            --shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        * { box-sizing: border-box; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background: var(--bg-body);
            color: var(--text);
            margin: 0; padding: 20px;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* –ê–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∂–∏–≤–æ–π —Ñ–æ–Ω */
        .bg-glow {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1; filter: blur(100px); opacity: 0.5;
        }
        .blob {
            position: absolute; width: 400px; height: 400px;
            background: var(--accent); border-radius: 50%;
            animation: move 20s infinite alternate;
        }

        @keyframes move {
            from { transform: translate(-10%, -10%); }
            to { transform: translate(100%, 50%); }
        }

        /* –ù–∞–≤–∏–≥–∞—Ü–∏—è –±—É–¥—É—â–µ–≥–æ */
        .nav-bar {
            display: flex; gap: 10px; margin-bottom: 40px;
            justify-content: center; position: sticky; top: 20px; z-index: 100;
        }
        .nav-btn {
            background: var(--glass); border: 1px solid var(--border);
            color: var(--text); padding: 12px 24px; border-radius: 50px;
            cursor: pointer; backdrop-filter: blur(15px);
            font-weight: 600; box-shadow: var(--shadow);
        }
        .nav-btn.active {
            background: var(--accent); color: white; border-color: var(--accent);
            transform: translateY(-3px); box-shadow: 0 10px 20px rgba(99, 102, 241, 0.4);
        }

        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∏ –ö–∞—Ä—Ç–æ—á–∫–∏ */
        .container { max-width: 1100px; margin: 0 auto; }
        
        .glass-card {
            background: var(--glass); backdrop-filter: blur(20px);
            border: 1px solid var(--border); border-radius: 32px;
            padding: 30px; box-shadow: var(--shadow);
        }

        header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 40px;
        }

        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 25px; }
        
        .stat-card {
            background: var(--glass); padding: 40px; border-radius: 32px;
            border: 1px solid var(--border); text-align: center;
            position: relative; overflow: hidden;
        }
        .stat-card:hover { transform: translateY(-10px) scale(1.02); }
        .stat-number { 
            font-size: 4em; font-weight: 800; 
            background: linear-gradient(45deg, var(--accent), var(--pink));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }

        /* –¢–∞–±–ª–∏—Ü–∞ */
        .table-container { overflow-x: auto; margin-top: 20px; }
        table { width: 100%; border-collapse: separate; border-spacing: 0 15px; }
        tr.grade-row { background: var(--glass); border-radius: 20px; box-shadow: var(--shadow); }
        td { padding: 25px; border: none; }
        td:first-child { border-radius: 24px 0 0 24px; }
        td:last-child { border-radius: 0 24px 24px 0; }

        .mark-badge {
            width: 50px; height: 50px; background: var(--accent);
            color: white; border-radius: 16px; display: grid; place-items: center;
            font-weight: 800; font-size: 1.3em; box-shadow: 0 8px 15px rgba(99, 102, 241, 0.3);
        }

        /* –§–æ—Ä–º—ã –∏ –∫–Ω–æ–ø–∫–∏ */
        .btn {
            background: var(--accent); color: white; border: none;
            padding: 14px 28px; border-radius: 16px; font-weight: 700;
            cursor: pointer; box-shadow: 0 10px 20px -5px rgba(99, 102, 241, 0.4);
        }
        .btn:hover { transform: scale(1.05); filter: brightness(1.1); }
        
        input, select, textarea {
            background: rgba(255,255,255,0.05) !important;
            border: 2px solid var(--border); border-radius: 16px;
            padding: 16px; color: var(--text) !important; font-family: inherit;
        }
        input:focus { border-color: var(--accent); outline: none; background: var(--glass) !important; }

        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ */
        #modal {
            display: none; position: fixed; inset: 0;
            background: rgba(0,0,0,0.4); backdrop-filter: blur(10px);
            z-index: 1000; align-items: center; justify-content: center;
        }
        .modal-content {
            background: var(--bg-body); width: 450px; padding: 40px;
            border-radius: 40px; border: 1px solid var(--border);
            animation: modalPop 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        @keyframes modalPop { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* –ê–Ω–∞–ª–∏—Ç–∏–∫–∞: –ø–æ–ª–æ—Å–∫–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ */
        .subject-bar-bg { width: 100%; height: 8px; background: rgba(0,0,0,0.1); border-radius: 10px; margin-top: 8px; }
        .subject-bar-fill { height: 100%; background: var(--accent); border-radius: 10px; }
    </style>
</head>
<body data-theme="dark">

<div class="bg-glow">
    <div class="blob"></div>
    <div class="blob" style="background: var(--pink); left: 50%; animation-delay: -5s;"></div>
</div>

<div class="container">
    <nav class="nav-bar">
        <button class="nav-btn active" onclick="showPage('home')">üè† –ì–ª–∞–≤–Ω–∞—è</button>
        <button class="nav-btn" onclick="showPage('journal')">üìö –ñ—É—Ä–Ω–∞–ª</button>
        <button class="nav-btn" onclick="showPage('stats')">üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞</button>
    </nav>

    <header class="glass-card" style="padding: 20px 40px;">
        <h1 style="margin:0; font-weight: 800; font-size: 24px; letter-spacing: -1px;">eMaktab <span style="color: var(--accent)">Galaxy</span></h1>
        <div style="display:flex; gap:12px;">
            <button class="nav-btn" onclick="toggleTheme()" id="themeIcon">‚òÄÔ∏è</button>
            <button class="btn" onclick="openModal()">+ –î–æ–±–∞–≤–∏—Ç—å –±–∞–ª–ª</button>
        </div>
    </header>

    <div id="page-home" class="page active">
        <div class="stats-grid">
            <div class="stat-card">
                <p style="text-transform: uppercase; font-weight: 800; opacity: 0.5; margin: 0;">–û—Ü–µ–Ω–æ–∫ –ø–æ–ª—É—á–µ–Ω–æ</p>
                <span id="stat-total" class="stat-number">0</span>
            </div>
            <div class="stat-card">
                <p style="text-transform: uppercase; font-weight: 800; opacity: 0.5; margin: 0;">–°—Ä–µ–¥–Ω–∏–π —É—Ä–æ–≤–µ–Ω—å</p>
                <span id="stat-avg" class="stat-number">0.0</span>
            </div>
        </div>
    </div>

    <div id="page-journal" class="page" style="display:none">
        <div class="table-container">
            <table id="gradesTable">
                <thead>
                    <tr style="opacity: 0.5;">
                        <th>–°–¢–£–î–ï–ù–¢</th>
                        <th>–ü–†–ï–î–ú–ï–¢</th>
                        <th>–ë–ê–õ–õ</th>
                        <th>–î–ê–¢–ê</th>
                        <th>–£–ü–†–ê–í–õ–ï–ù–ò–ï</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <div id="page-stats" class="page" style="display:none">
        <div class="glass-card">
            <h2 style="margin-top:0">–ü—Ä–æ–≥—Ä–µ—Å—Å –ø–æ –¥–∏—Å—Ü–∏–ø–ª–∏–Ω–∞–º</h2>
            <div id="subject-list"></div>
        </div>
    </div>
</div>

<div id="modal">
    <div class="modal-content">
        <h2 id="modalTitle" style="margin-top:0; font-weight: 800;">–ù–æ–≤–∞—è –∑–∞–ø–∏—Å—å</h2>
        <div style="display: flex; flex-direction: column; gap: 15px;">
            <input type="hidden" id="editId">
            <input type="text" id="studentName" placeholder="–ò–º—è —Å—Ç—É–¥–µ–Ω—Ç–∞">
            <select id="subject">
                <option value="" disabled selected>–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç</option>
                <option value="–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞">üìê –ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞</option>
                <option value="–§–∏–∑–∏–∫–∞">‚öõÔ∏è –§–∏–∑–∏–∫–∞</option>
                <option value="–ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–∫–∞">üíª –ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–∫–∞</option>
                <option value="–ê–Ω–≥–ª–∏–π—Å–∫–∏–π">üá¨üáß –ê–Ω–≥–ª–∏–π—Å–∫–∏–π</option>
            </select>
            <input type="number" id="mark" min="1" max="10" placeholder="–ë–∞–ª–ª (1-10)">
            <textarea id="comment" placeholder="–î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..."></textarea>
            <button class="btn" onclick="handleSave()">–ó–∞–ø–∏—Å–∞—Ç—å –≤ –±–ª–æ–∫—á–µ–π–Ω</button>
            <button onclick="closeModal()" style="background: none; border: none; color: var(--text); opacity: 0.5; cursor: pointer;">–û—Ç–º–µ–Ω–∏—Ç—å</button>
        </div>
    </div>
</div>

<script>
    // –¢–≤–æ–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Supabase (—Å–æ—Ö—Ä–∞–Ω–∏–ª –∏–∑ –æ—Ä–∏–≥–∏–Ω–∞–ª–∞)
    const SB_URL = 'https://fjhoiaboaozetmzzdbjg.supabase.co';
    const SB_KEY = 'sb_publishable_eJJcBHyRDDklrFjpeDIMOA_wHjfdFim';
    const _supabase = supabase.createClient(SB_URL, SB_KEY);

    function showPage(pageId) {
        document.querySelectorAll('.page').forEach(p => p.style.display = 'none');
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        
        document.getElementById('page-' + pageId).style.display = 'block';
        event.currentTarget.classList.add('active');
        
        if(pageId !== 'journal') updateStats();
    }

    function toggleTheme() {
        const body = document.body;
        const isDark = body.getAttribute('data-theme') === 'dark';
        body.setAttribute('data-theme', isDark ? 'light' : 'dark');
        document.getElementById('themeIcon').innerText = isDark ? 'üåô' : '‚òÄÔ∏è';
    }

    async function fetchGrades() {
        const { data, error } = await _supabase.from('grades').select('*').order('date', { ascending: false });
        if (error) return;

        const tbody = document.querySelector('#gradesTable tbody');
        tbody.innerHTML = '';
        data.forEach(g => {
            tbody.innerHTML += `
                <tr class="grade-row">
                    <td><div style="font-weight:700">${g.student}</div><small style="opacity:0.5">${g.comment || ''}</small></td>
                    <td><span style="background:rgba(99,102,241,0.1); padding:5px 12px; border-radius:10px; font-size:0.9em">${g.subject}</span></td>
                    <td><div class="mark-badge">${g.mark}</div></td>
                    <td style="opacity:0.6">${new Date(g.date).toLocaleDateString()}</td>
                    <td>
                        <button class="btn" style="background:#42A5F5; padding:8px 12px; box-shadow:none" onclick="editGrade('${g.id}','${g.student}','${g.subject}',${g.mark},'${g.comment||''}')">‚úé</button>
                        <button class="btn" style="background:#EF5350; padding:8px 12px; box-shadow:none" onclick="deleteGrade('${g.id}')">‚úï</button>
                    </td>
                </tr>`;
        });
        updateStats();
    }

    async function updateStats() {
        const { data } = await _supabase.from('grades').select('mark, subject');
        if (!data) return;

        document.getElementById('stat-total').innerText = data.length;
        const avg = data.length > 0 ? (data.reduce((s, c) => s + c.mark, 0) / data.length).toFixed(1) : 0;
        document.getElementById('stat-avg').innerText = avg;

        const subjList = document.getElementById('subject-list');
        subjList.innerHTML = '';
        
        const subjects = {};
        data.forEach(g => {
            if(!subjects[g.subject]) subjects[g.subject] = { sum: 0, count: 0 };
            subjects[g.subject].sum += g.mark;
            subjects[g.subject].count++;
        });

        for(let s in subjects) {
            const sAvg = (subjects[s].sum / subjects[s].count).toFixed(1);
            const percent = (sAvg / 10) * 100;
            subjList.innerHTML += `
                <div style="margin-bottom:20px">
                    <div style="display:flex; justify-content:space-between; margin-bottom:5px">
                        <span><b>${s}</b> (${subjects[s].count} –æ—Ü–µ–Ω–æ–∫)</span>
                        <b>${sAvg} / 10</b>
                    </div>
                    <div class="subject-bar-bg">
                        <div class="subject-bar-fill" style="width: ${percent}%"></div>
                    </div>
                </div>`;
        }
    }

    async function handleSave() {
        const id = document.getElementById('editId').value;
        const payload = {
            student: document.getElementById('studentName').value,
            subject: document.getElementById('subject').value,
            mark: parseInt(document.getElementById('mark').value),
            comment: document.getElementById('comment').value,
            date: new Date()
        };

        if(!payload.student || !payload.mark) return alert("–ó–∞–ø–æ–ª–Ω–∏ –¥–∞–Ω–Ω—ã–µ!");

        const res = id 
            ? await _supabase.from('grades').update(payload).eq('id', id)
            : await _supabase.from('grades').insert([payload]);

        if(!res.error) { closeModal(); fetchGrades(); }
    }

    async function deleteGrade(id) {
        if(confirm("–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å –∏–∑ —Å–∏—Å—Ç–µ–º—ã?")) {
            await _supabase.from('grades').delete().eq('id', id);
            fetchGrades();
        }
    }

    function editGrade(id, name, subj, mark, comm) {
        document.getElementById('editId').value = id;
        document.getElementById('studentName').value = name;
        document.getElementById('subject').value = subj;
        document.getElementById('mark').value = mark;
        document.getElementById('comment').value = comm;
        document.getElementById('modalTitle').innerText = "–ò–∑–º–µ–Ω–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏";
        openModal();
    }

    function openModal() { document.getElementById('modal').style.display = 'flex'; }
    function closeModal() { document.getElementById('modal').style.display = 'none'; }

    window.onload = fetchGrades;
</script>
</body>
</html>
